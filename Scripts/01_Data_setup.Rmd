---
title: "01_Data_Setup"
author: "Calen P. Ryan"
date: "6/30/2021"
output: html_document
---

We have data in dozens of files across decades of time. We need the data in the format we can work with. I'll start bringing things together. A key aspect to this analysis is that it has to be **scaleable**, in that we will later expand the sample size and need to make it as easy as possible to do so without massive changes to the code. 



# Load packages
```{r}
library(tidyverse) # great collection of packages for data carpentry, modelling, and visualization
library(readr)
library(haven) # package for loading Stata's .dta files. 
library(sjlabelled) # good for renaming, changing classes, etc. in the piped dplyr mode
library(zscorer)
library(lubridate)
library(anthro)
library(childsds)
here::here()
# sets a placeholder 'here'. Then we refer to our files based on the *relative* not the *absolute* location.
```

# Load maternal/child data, birthdays, and early growth parameters

# Load and inspect 83-86
```{r}

mbirth2 <-read_dta(here::here("Projects/Catchup_Growth/Data/zip_mother_1983_86/mbirth2.dta")) %>% # note: here::here calls the here function
  rename_all(tolower)

mlong <-read_dta(here::here("Projects/Catchup_Growth/Data/zip_mother_1983_86/mlong.dta")) %>% # note: here::here calls the here function
  rename_all(tolower)

dim(mbirth2)
dim(mlong)
```
```{r}
names(mbirth2)

```
```{r}
names (mlong)
```


Lots of names that are not easy to interpret. We must read the document
```{r}
file.show(here::here("Projects/Catchup_Growth/Data/zip_mother_1983_86/mbirth2.dta")) # or you can click on it - easier to 'control + f ' to find words

view(mlong)


```

Find the variables that relate to growth in this dataset
```{r, cache=TRUE}

growth83_86_birthdata<-mbirth2 %>% 
  select(basebrgy,hhldnubi, basewman, sexchild, outcome, daybirth, mnthbrth, yearbirt, dayintw, mothintw, yearintw, bbweight, weight1, weightak, weightgm, heightcm )


 growth83_86_birthdata <- growth83_86_birthdata %>%  
  mutate(weightak_kg = (weightak/1900)) %>% 
  mutate(birthdate = make_date(yearbirt + 1900, mnthbrth, daybirth)) %>% 
  mutate(intwdate = make_date(yearintw +1900, mothintw, dayintw)) %>% 
  mutate(age_days_birthweigh = as.numeric(intwdate - birthdate)) %>%
  filter(outcome != "2" | outcome !="3" ) %>% 
  filter(age_days_birthweigh < 30) %>% 
  filter(age_days_birthweigh > 0) %>% 
  filter(weightak > 0) %>% 
  filter(heightcm > 0) 
 
growth83_86_birthdata <- addWGSR(data = growth83_86_birthdata, sex = "sexchild", firstPart= "weightak_kg", secondPart = "age_days_birthweigh", index = "wfa")

growth83_86_birthdata <- addWGSR(data = growth83_86_birthdata, sex = "sexchild", firstPart = "heightcm", secondPart = "age_days_birthweigh", index = "hfa")

```

```{r, cache=TRUE}
 mlong_anthro <-mlong %>% 
  select(basebrgy, basewman, weight, height, yearms, mntham, daymes) %>% 
  mutate(date_inf_meas = lubridate::make_date(year = yearms+1900,
                                              month = mntham,
                                              day = daymes)) %>% 
  arrange(desc(basewman, basebrgy, date_inf_meas))


birthdates_data <- growth83_86_birthdata %>% 
  select(basebrgy, basewman, sexchild, birthdate)

mlong_anthro_bday <- left_join(birthdates_data, mlong_anthro, by = c("basebrgy", "basewman")) %>% 
  unite(basebrgy, basewman, sep = "_", col = "basebrgy_basewman") 

mlong_anthro_bday <- mlong_anthro_bday %>% 
   mutate(age_days_infweigh = as.numeric(date_inf_meas - birthdate)) %>% 
   mutate(weight_kg = (weight/1000))

 
growth83_86_infdata <-mlong_anthro_bday %>%
  select(basebrgy_basewman, weight_kg, height, date_inf_meas, age_days_infweigh, birthdate) %>%
  group_by(basebrgy_basewman) %>%
  mutate(id = row_number()) %>%
  filter(id == max(id) | id == min(id)) %>%
  arrange(basebrgy_basewman, id)


growth83_86_infdata %>%
  mutate(weight_diff = weight_kg - lag(weight_kg, default = first(weight_kg)),
         height_diff = height - lag(height, default = first(height)),
         time_diff =   age_days_infweigh - lag(age_days_infweigh)) %>%
  select(basebrgy_basewman, weight_diff, height_diff, time_diff, everything(.)) %>% 
  spread(key = id, value = weight_kg, drop = TRUE) 

growth83_86_infdata

growth83_86_infdata <- addWGSR(data = growth83_86_infdata, sex = "sexchild", firstPart= "weight_kg", secondPart = "age_days_infweigh", index = "wfa")

growth83_86_infdata <- addWGSR(data = growth83_86_infdata, sex = "sexchild", firstPart = "height", secondPart = "age_days_infweigh", index = "hfa")

```

```{r}
growth83_86_birthdata <- growth83_86_birthdata %>% 
  rename( wfaz_birth = wfaz, hfaz_birth = hfaz)

growth83_86_infdata <- growth83_86_infdata %>% 
  rename( wfaz_inf = wfaz, hfaz_inf = hfaz)

growth83_86_data <- left_join(growth83_86_birthdata, growth83_86_infdata, by = c("basebrgy", "basewman", "sexchild", "birthdate"))

growth83_86_data
```

```{r}
ggplot(growth83_86_data, aes(x = weight1))+
  geom_histogram(color = "white")+
  facet_wrap(~sexchild)

ggplot(growth83_86_data, aes(x = weightak))+
  geom_histogram(color = "white")+
  facet_wrap(~sexchild)

ggplot(growth83_86_data, aes(x = weightgm))+
  geom_histogram(color = "white")+
  facet_wrap(~sexchild)
  
ggplot(growth83_86_data, aes(x=heightcm))+
  geom_histogram(color = "white")+
  facet_wrap(~sexchild)

summary_weight83_86 <- growth83_86_data %>%
  group_by(sexchild) %>% 
  drop_na() %>%
  summarize(mean_weight83_86 = mean(weightak),
            std_dev_weight83_86 = sd(weightak),
            med_weight83_86 = median(weightak),
            count = n(), .groups = "keep")

summary_height83_86 <- growth83_86_data %>%
  group_by(sexchild) %>% 
  drop_na() %>%
  summarize(mean_height83_86 = mean(heightcm),
            std_dev_height83_86 = sd(heightcm),
            med_height83_86 = median(heightcm),
            count = n(), .groups = "keep")

summary_weight83_86
summary_height83_86 
```


#Load and inspect 91 data
```{r}
child2 <-read_dta(here::here("Projects/Catchup_Growth/Data/zip_child_91/child291.dta")) %>% # note: here::here calls the here function
  rename_all(tolower)

hhold91 <-read_dta(here::here("Projects/Catchup_Growth/Data/zip_household_91/hhold91.dta")) %>% # note: here::here calls the here function
  rename_all(tolower)


dim(child2)
dim(hhold91)
```

```{r}
growth2 <-child2 %>%
  select(basebrgy, basewman, basehhno, currbrgy, weghtndx, hightndx) 

intw_date91 <- hhold91 %>% 
  select(basebrgy, basewman, mointr91, dyintrvw, yrintr91)

growth91_data <- left_join(growth2, intw_date91, by = c("basebrgy", "basewman"))
         
growth91_data <- left_join(growth91_data, birthdates_data, by = c("basebrgy", "basewman"))

growth91_data
```

```{r, cache=TRUE}

growth91_data<- growth91_data %>% 
  mutate(intwdate91 = make_date( yrintr91+1900, mointr91, dyintrvw)) %>% 
  mutate(age91_days = as.numeric(intwdate91 - birthdate)) %>% 
  mutate(age91_years = as.numeric(intwdate91 - birthdate)/365.25) %>% 
  mutate(age_mo_91 = age91_years*12) %>% 
  filter(age91_days > 0) %>% 
  filter(weghtndx > 0) %>% 
  filter(hightndx > 0)

growth91_data <- addWGSR(data = growth91_data, sex = "sexchild", firstPart= "weghtndx", secondPart = "age91_days", index = "wfa")

growth91_data <- addWGSR(data = growth91_data, sex = "sexchild", firstPart = "hightndx", secondPart = "age91_days", index = "hfa")

growth91_data <- growth91_data %>% 
  rename( wfaz_91 = wfaz, hfaz_91 = hfaz)


growth91_data

```
```{r}
ggplot(growth91_data, aes(x= weghtndx))+
  geom_histogram(color = "white")+
  facet_wrap(~sexchild)

ggplot(growth91_data, aes(x=hightndx))+
  geom_histogram(color = "white")+
  facet_wrap(~sexchild)

summary_weight91 <- growth91_data %>%
  group_by(sexchild) %>% 
  drop_na() %>%
  summarize(mean_weight91 = mean(weghtndx),
            std_dev_weight91 = sd(weghtndx),
            med_weight91 = median(weghtndx),
            count = n(), .groups = "keep")

summary_height91 <- growth91_data %>%
  group_by(sexchild) %>% 
  drop_na() %>%
  summarize(mean_height91 = mean(hightndx),
            std_dev_height91 = sd(hightndx),
            med_height91 = median(hightndx),
            count = n(), .groups = "keep")

summary_weight91
summary_height91
```

#Load and inspect 02 data


```{r}
anthdiet <-read_dta(here::here("~/Projects/Catchup_Growth/Data/zip_child_2002/anthdiet.dta")) %>% # note: here::here calls the here function
  rename_all(tolower)

screen_data<-read_dta(here::here("Projects/Catchup_Growth/Data/zip_child_2002/screen.dta")) %>% # note: here::here calls the here function
  rename_all(tolower)

anthdiet <- anthdiet %>% 
  select(basebrgy, basewman, height)

screen_data <- screen_data %>% 
  select(basebrgy, basewman, dayntrvw, yrntrvw, montrvw) %>% 
  mutate(intw_date02 = make_date(yrntrvw, montrvw, dayntrvw))
 

screen_data <- left_join(birthdates_data, screen_data, by = c("basebrgy", "basewman")) %>% 
  mutate(age_days_02 = as.numeric(intw_date02 - birthdate)) %>% 
  mutate(age_years_02 = age_days_02/365.25) %>% 
  mutate(age_cutoff = if_else(age_years_02 > 19, 19, age_years_02)) %>% 
  mutate(age_cutoff_days = age_cutoff*365.25)

growth02_data <- left_join(screen_data, anthdiet, by = c("basebrgy", "basewman"))

growth02_data <- addWGSR(data = growth02_data, sex = "sexchild", firstPart= "height", secondPart = "age_cutoff_days", index = "hfa") %>% 
   rename(hfaz_02 = hfaz)


growth02_data




```


```{r}

```

#zscore analysis

```{r, cache=TRUE }
zscore_data <- left_join(growth83_86_data, growth91_data, by = c("basebrgy", "basewman", "sexchild")) 
zscore_data <- left_join(zscore_data, growth02_data, by = c("basebrgy", "basewman", "sexchild"))

zscore_wfa<- zscore_data %>% 
  select(basebrgy, basewman, sexchild, age_days_birthweigh, age_days_infweigh, age91_days, wfaz_birth, wfaz_inf, wfaz_91)

zscore_hfa <-zscore_data %>% 
  select(basebrgy, basewman, sexchild, age_days_birthweigh, age_days_infweigh, age91_days, hfaz_birth, hfaz_inf, hfaz_91, hfaz_02)

zscore_hfa
zscore_wfa

slope <- function(x0,x1,y0,y1) (y1-y0)/(x1-x0)
slope(zscore_hfa[1,4],zscore_hfa[1,5],zscore_hfa[1,7],zscore_hfa[1,8])
```


```{r}

```



