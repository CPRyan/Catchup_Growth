---
title: "01_Data_Setup"
author: "Calen P. Ryan"
date: "6/30/2021"
output: html_document
---

We have data in dozens of files across decades of time. We need the data in the format we can work with. I'll start bringing things together. A key aspect to this analysis is that it has to be **scaleable**, in that we will later expand the sample size and need to make it as easy as possible to do so without massive changes to the code. 



# Load packages
```{r}
library(tidyverse) # great collection of packages for data carpentry, modelling, and visualization
library(haven) # package for loading Stata's .dta files. 
library(sjlabelled) # good for renaming, changing classes, etc. in the piped dplyr mode
library(zscorer)
library(lubridate)
here::here()
# sets a placeholder 'here'. Then we refer to our files based on the *relative* not the *absolute* location.
```



# Load maternal/child data, birthdays, and early growth parameters

# Load and inspect 83-86
```{r}

mbirth2 <-read_dta(here::here("Data/zip_mother_1983_86/mbirth2.dta")) %>% # note: here::here calls the here function
  rename_all(tolower)

dim(mbirth2)
```
```{r}
names(mbirth2)
```
Lots of names that are not easy to interpret. We must read the document
```{r}
file.show(here::here("Data/zip_mother_1983_86/mbirth.txt")) # or you can click on it - easier to 'control + f ' to find words

```

Find the variables that relate to growth in this dataset
```{r}

growth83_86_data<-mbirth2 %>% 
  select(basebrgy,hhldnubi, basewman, sexchild, outcome, daybirth, mnthbrth, yearbirt, dayintw, mothintw, yearintw, bbweight,weight1, weightak, weightgm, heightcm ) %>% 
  mutate(weightak_kg = (weightak/1000)) %>% 
  mutate(birthdate = make_date(yearbirt, mnthbrth, daybirth)) %>% 
  mutate(intwdate = make_date(yearintw, mothintw, dayintw)) %>% 
  mutate(age_at_weigh_days = as.numeric(intwdate - birthdate)) %>%
  filter(outcome != "2" | outcome !="3" ) %>% 
  filter(age_at_weigh_days < 30)

  
growth83_86_data <- addWGSR(data = growth83_86_data, sex = "sexchild", firstPart= "weightak_kg", secondPart = "age_at_weigh_days", index = "wfa")

growth83_86_data <- addWGSR(data = growth83_86_data, sex = "sexchild", firstPart = "heightcm", secondPart = "age_at_weigh_days", index = "hfa")


growth83_86_data

```

```{r}
ggplot(growth83_86_data, aes(x = weight1))+
  geom_histogram(color = "white")

ggplot(growth83_86_data, aes(x = weightak))+
  geom_histogram(color = "white")

ggplot(growth83_86_data, aes(x = weightgm))+
  geom_histogram(color = "white")
  
ggplot(growth83_86_data, aes(x=heightcm))+
  geom_histogram(color = "white")
```
```{r}

ggplot(growth83_86_data, aes(x=wfaz))+
  geom_histogram(color = "white")+
  facet_wrap(~sexchild)


ggplot(growth83_86_data, aes(x=hfaz))+
  geom_histogram(color = "white")+
  facet_wrap(~sexchild)
  
summary_wfaz83_86
summary_hfaz83_86
```

```{r}
child2 <-read_dta(here::here("Data/zip_child_91/child291.dta")) %>% # note: here::here calls the here function
  rename_all(tolower)

childiq <-read_dta(here::here("Data/zip_child_91/iq91.dta")) %>% # note: here::here calls the here function
  rename_all(tolower)


getwd()
#who2007_boys<- read_csv(here::here("Data/hfa-boys-z-who-2007-exp.csv"))
who2007_boys <- read.csv("../Data/hfa-boys-z-who-2007-exp.csv",header=TRUE)
who2007_boys

#who2007_girls <- read_csv(here::here("Data/hfa-girls-z-who-2007-exp.csv"))

dim(child2)
dim(childiq)
```

```{r}
growth2 <-child2 %>%
  select(basebrgy, basewman, basehhno, currbrgy, weghtndx, hightndx) 

childiq_dates <-childiq %>% 
  select(basebrgy, basewman,monthiq, dayiq, yeariq )

birthdates_data <- growth83_86_data %>% 
  select(basebrgy, basewman, sexchild, birthdate)

growth91_data <- left_join(growth2, childiq_dates, by = c("basebrgy", "basewman"))
         
growth91_data <- left_join(growth91_data, birthdates_data, by = c("basebrgy", "basewman"))

growth91_data
```

```{r}
growth91_data<- growth91_data %>% 
  mutate(intwdate2 = make_date(yeariq, monthiq, dayiq)) %>% 
  mutate(age2_days = as.numeric(intwdate2 - birthdate))

growth91_data <- addWGSR(data = growth91_data, sex = "sexchild", firstPart= "weghtndx", secondPart = "age2_days", index = "wfa")

growth91_data <- addWGSR(data = growth91_data, sex = "sexchild", firstPart = "hightndx", secondPart = "age2_days", index = "hfa")

growth91_data
<<<<<<< HEAD
```
```{r}
ggplot(growth91_data, aes(x=wfaz))+
=======
zscores91
```
```{r}
ggplot(growth91_data, aes(x= weghtndx))+
  geom_histogram(color = "white")+
  facet_wrap(~sexchild)

ggplot(growth91_data, aes(x=hightndx))+
  geom_histogram(color = "white")+
  facet_wrap(~sexchild)

summary_weight91 <- growth91_data %>%
  group_by(sexchild) %>% 
  drop_na() %>%
  summarize(mean_weight91 = mean(weghtndx),
            std_dev_weight91 = sd(weghtndx),
            med_weight91 = median(weghtndx),
            count = n(), .groups = "keep")

summary_height91 <- growth91_data %>%
  group_by(sexchild) %>% 
  drop_na() %>%
  summarize(mean_height91 = mean(hightndx),
            std_dev_height91 = sd(hightndx),
            med_height91 = median(hightndx),
            count = n(), .groups = "keep")

summary_weight91
summary_height91
```

#Load and inspect 94 data


```{r}

cdietiq <-read_dta(here::here("Data/zip_child_94 2/cdietiq.dta")) %>% # note: here::here calls the here function
  rename_all(tolower)

dim(cdietiq)
names(cdietiq)
```

```{r}
# write a function to calculate z-scores from WHO tables

# need a column of rounded ages in months

calcz <- function(age,val,whotab=who2007_girls){
  age <- round(age)
  i <- which(whotab$Month == age)
  z <- (val - as.numeric(whotab[i,"M"]))/as.numeric(whotab[i,"StDev"])
  return(z)
}

calcz(age=102,val=115)
whotab <- who2007_girls

i <- 10
as.numeric(whotab[i,"StDev"])

zzz <- rep(0,dim(growth94_data)[1])
for(j in 1:dim(growth94_data)[1]){
  zzz[j] <- calcz(age=whotab[j,"Month"], val=whotab[j,"M"],whotab=whotab)
}

```

<!---
probably want to create a single table with 
tab <- data.frame(age=Month,boysval,boyssd,girlsval,girlssd)
c <- ifelse(sex==1,2,4)
then the z calc would be
z <- (val - tab[i,c])/tab[i,c+1]

so this:

calcz <- function(age,val,sex,whotab){
  age <- round(age)
  c <- ifelse(sex==1,2,4)
  i <- which(whotab$age == age)
  z <- (val - tab[i,c])/tab[i,c+1]
  return(z)
}
-->

```{r}
growth94_data <- cdietiq %>% 
  select(basebrgy, basehhn2,basewman,chldwma2,chldcode, mointrv2, dyintrv2, yrintrv2, weghtnd2, hightnd2) %>% 
  filter(chldcode == "1")

growth94_data <- left_join(growth94_data, birthdates_data, by = c("basebrgy", "basewman")) 

growth94_data <- growth94_data %>% 
  mutate(intwdate3 = make_date(yrintrv2, mointrv2, dyintrv2)) %>% 
  mutate(age3_days = as.numeric(intwdate3 - birthdate)) %>% 
  mutate(age3_years = as.numeric(intwdate3 - birthdate)/365.25) %>% 
  mutate(age3_months = age3_years*12) %>% 
  filter(age3_days > 0) %>% 
  filter(weghtnd2 > 0) %>% 
  filter(hightnd2 > 0) %>% 
  drop_na() 
  
height_94_boys <- growth94_data %>%
  filter(sexchild == "1") %>% 
  mutate(heightz_94 = calcz(age= age3_months, val= hightnd2, whotab=who2007_boys))
  
rlang::last_error()

growth94_data
growth94_data$hightnd2
max(who2007_boys$Month)
max(growth94_data$age3_months)

# this works
with(growth94_data, calcz(age=age3_months[1],val=hightnd2[1], whotab=who2007_boys))
##
height_94_boys <- growth94_data %>%
  filter(sexchild == "1")

dim(height_94_boys)
# [1] 88 16
zzz <- rep(0,88)
boy_height <- as.vector(height_94_boys$hightnd2)
boy_age <- as.vector(height_94_boys$age3_months)
boy_height
boy_age

for(j in 1:88) zzz[j] <- calcz(age=boy_age[j], val=boy_height[j], whotab=who2007_boys)
length(zzz)
zzz


## this does weird things. First 88 are fine, but then there are lots of zeros (hundreds).
for(j in 1:88) zzz[j] <- calcz(age=height_94_boys$age3_months[j],val=height_94_boys$hightnd2[j], whotab=who2007_boys)
unlist(zzz)

 zscores_94 <- weightZ_94 = sds(value = growth94_data$weghtnd2,
                          age =   growth94_data$age3_years,
                          sex =   growth94_data$sexchild, male = "1", female = "2",
                          ref =   who.ref,
                          item =  "weight",
                          type =  "SDS"
                           )
 

growth94_data

  
```

```{r} 

ggplot(growth94_data, aes(x=weghtnd2))+
>>>>>>> 91e3e4b26e026fdb8f135bb2eb4fa099e84bbda2
  geom_histogram(color = "white")+
  facet_wrap(~sexchild)

ggplot(growth91_data, aes(x=hfaz))+
  geom_histogram(color = "white")+
  facet_wrap(~sexchild)

```

