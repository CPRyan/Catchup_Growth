---
title: "01_Data_Setup"
author: "Milan Hilde-Jones and Calen P. Ryan"
date: "6/30/2021"
output: html_document
---

We have data in dozens of files across decades of time. We need the data in the format we can work with. I'll start bringing things together. A key aspect to this analysis is that it has to be **scaleable**, in that we will later expand the sample size and need to make it as easy as possible to do so without massive changes to the code. 



# Load packages
```{r}
library(tidyverse) # great collection of packages for data carpentry, modelling, and visualization
library(readr)
library(haven) # package for loading Stata's .dta files. 
library(sjlabelled) # good for renaming, changing classes, etc. in the piped dplyr mode
library(zscorer)
library(lubridate)
library(anthro)
library(childsds)
library(sjlabelled)
library(sjPlot)
library(VIF)
library(car)
here::here()
# sets a placeholder 'here'. Then we refer to our files based on the *relative* not the *absolute* location.
```

# Load maternal/child data, birthdays, and early growth parameters

# Load and inspect 83-86
```{r}
mbirth2 <-read_dta(here::here("Data/zip_mother_1983_86/mbirth2.dta")) %>% # note: here::here calls the here function
  rename_all(tolower) %>% 
  unite(basebrgy, basewman, sep = "_", col = "basebrgy_basewman")

mlong <-read_dta(here::here("Data/zip_mother_1983_86/mlong.dta")) %>% # note: here::here calls the here function
  rename_all(tolower) %>% 
  unite(basebrgy, basewman, sep = "_", col = "basebrgy_basewman")
  
  


dim(mbirth2)
dim(mlong)
```

## names of mbirth2
```{r eval = FALSE}
names(mbirth2)
```
## Names of mlong
```{r eval = FALSE}
names (mlong)
```


Find the variables that relate to growth in this dataset
```{r, cache=TRUE}
#subset mbirth data 
growth83_86_birthdata<-mbirth2 %>% 
  select(basebrgy_basewman, sexchild, outcome, daybirth, mnthbrth, yearbirt, dayintw, mothintw, yearintw, bbweight, weight1, weightak, weightgm, heightcm )
  

#Create variables for birthday and age at first weigh
 growth83_86_birthdata <- growth83_86_birthdata %>%  
  mutate(weightak_kg = (weightak/1900)) %>% 
  mutate(birthdate = make_date(yearbirt + 1900, mnthbrth, daybirth)) %>% 
  mutate(intwdate = make_date(yearintw +1900, mothintw, dayintw)) %>% 
  mutate(age_days_birthweigh = as.numeric(intwdate - birthdate)) %>%
  filter(outcome != "2" | outcome !="3" ) %>% 
  filter(age_days_birthweigh < 30) %>% 
  filter(age_days_birthweigh > 0) %>% 
  filter(weightak > 0) %>% 
  filter(heightcm > 0) 

#zscores for birth data and rename wfaz/hfaz
 
growth83_86_birthdata <- addWGSR(data = growth83_86_birthdata, sex = "sexchild", firstPart= "weightak_kg", secondPart = "age_days_birthweigh", index = "wfa")

growth83_86_birthdata <- addWGSR(data = growth83_86_birthdata, sex = "sexchild", firstPart = "heightcm", secondPart = "age_days_birthweigh", index = "hfa")

growth83_86_birthdata <- growth83_86_birthdata %>% 
  rename( wfaz_birth = wfaz, hfaz_birth = hfaz)

```

```{r, cache=TRUE}
#subset mlong data and add date of interview
mlong_anthro <-mlong %>% 
  select(basebrgy_basewman, weight, height, yearms, mntham, daymes) %>% 
  mutate(date_inf_meas = lubridate::make_date(year = yearms+1900,
                                              month = mntham,
                                              day = daymes)) %>% 
  arrange(desc(basebrgy_basewman, date_inf_meas)) 


#make a subset for birthday data
birthdates_data <- growth83_86_birthdata %>% 
  select(basebrgy_basewman, sexchild, birthdate) 
  
#join birthdata and mlong to calculate ages
#unite identifier variables

mlong_anthro_bday <- left_join(birthdates_data, mlong_anthro, by = c("basebrgy_basewman"))
 
mlong_anthro_bday <- mlong_anthro_bday %>% 
   mutate(age_days_infweigh = as.numeric(date_inf_meas - birthdate)) %>% 
   mutate(weight_kg = (weight/1000))

# make the mlong data into wide form, creade new id variables for weight and height 1/12 to reflect first and last infancy measurements

weight_mlong_bday <-mlong_anthro_bday %>%
  select(basebrgy_basewman, sexchild, weight_kg, yearms, mntham, daymes, date_inf_meas, age_days_infweigh, birthdate) %>%
  group_by(basebrgy_basewman) %>%
  mutate(id = row_number()) %>%
  filter(id == max(id)) %>%
  arrange(basebrgy_basewman, id) %>% 
  spread(key = id, value = weight_kg, drop = TRUE) %>% 
  rename(wght_12 = "12" )


height_mlong_bday <-mlong_anthro_bday %>%
  select(basebrgy_basewman, sexchild, height, date_inf_meas, age_days_infweigh, birthdate) %>%
  group_by(basebrgy_basewman) %>%
  mutate(id = row_number()) %>%
  filter(id == max(id)) %>%
  arrange(basebrgy_basewman, id) %>% 
  spread(key = id, value = height, drop = TRUE) %>% 
  rename(hght_12 = "12" )

weight_mlong_bday
height_mlong_bday

# height_mlong_bday %>% 
#   group_by(basebrgy_basewman) %>% 
#   summarize(n = n()) %>% 
#   filter(n > 1)
```


```{r, cache=TRUE}

#weight zscores infancy
weight_mlong_bday_12 <- weight_mlong_bday %>% 
  select(basebrgy_basewman, sexchild, yearms, mntham, daymes, date_inf_meas, age_days_infweigh, birthdate, "wght_12")

weight_mlong_bday_12 <- addWGSR(data = weight_mlong_bday_12, sex = "sexchild", firstPart= "wght_12", secondPart = "age_days_infweigh", index = "wfa") %>% 
  rename( wfaz_inf_12 = wfaz)

#height z scores infancy

height_mlong_bday_12 <- height_mlong_bday %>% 
  select(basebrgy_basewman, sexchild, date_inf_meas, age_days_infweigh, birthdate, "hght_12")

height_mlong_bday_12 <- addWGSR(data = height_mlong_bday_12, sex = "sexchild", firstPart= "hght_12", secondPart = "age_days_infweigh", index = "hfa") %>% 
  rename( hfaz_inf_12 = hfaz)


# weight_mlong_bday_12 %>%
#   group_by(basebrgy_basewman) %>%
#   summarize(n = n()) %>%
#   filter(n > 1)
```

```{r, cache=TRUE}
#join wfa and hfa zscores in one table
intersect(names(height_mlong_bday_12), names(weight_mlong_bday_12))

growth83_86_infdata <-left_join(height_mlong_bday_12, weight_mlong_bday_12 %>%  
                               select(-date_inf_meas, -age_days_infweigh, -birthdate, -sexchild), by = c("basebrgy_basewman")) 

growth83_86_infdata
 

# There isn't anything loaded yet that is called hfa_diff1 or hfa_diff2. 

# zscore_hfa_diffs <- left_join(hfa_diff1, hfa_diff2 %>% 
#                                select(-sexchild, -hfaz_inf_12), by = c("basebrgy_basewman"))
# 
# zscore_hfa_diffs
# 
# 
# zscore_hfa_diffs %>% 
#   group_by(basebrgy_basewman) %>%
#   summarize(n = n()) %>%
#   filter(n > 1)
```


```{r}
#make one big 83/86 table with z scores
intersect(names(growth83_86_birthdata), names(growth83_86_infdata))

growth83_86_data <- left_join(growth83_86_birthdata, growth83_86_infdata %>% 
                                select(-sexchild, -birthdate), by = c("basebrgy_basewman")) 

# growth83_86_data %>% 
#   group_by(basebrgy_basewman) %>%
#   summarize(n = n()) %>%
#   filter(n > 1)
```

```{r}
#model weight distributions 
ggplot(growth83_86_data, aes(x = weight1))+
  geom_histogram(color = "white")+
  facet_wrap(~sexchild)

ggplot(growth83_86_data, aes(x = weightak))+
  geom_histogram(color = "white")+
  facet_wrap(~sexchild)

ggplot(growth83_86_data, aes(x = weightgm))+
  geom_histogram(color = "white")+
  facet_wrap(~sexchild)

#model height distributions  
ggplot(growth83_86_data, aes(x=heightcm))+
  geom_histogram(color = "white")+
  facet_wrap(~sexchild)

#summary stats of weight and height
summary_weight83_86 <- growth83_86_data %>%
  group_by(sexchild) %>% 
  drop_na() %>%
  summarize(mean_weight83_86 = mean(weightak),
            std_dev_weight83_86 = sd(weightak),
            med_weight83_86 = median(weightak),
            count = n(), .groups = "keep")

summary_height83_86 <- growth83_86_data %>%
  group_by(sexchild) %>% 
  drop_na() %>%
  summarize(mean_height83_86 = mean(heightcm),
            std_dev_height83_86 = sd(heightcm),
            med_height83_86 = median(heightcm),
            count = n(), .groups = "keep")

summary_weight83_86
summary_height83_86 
```


#Load and inspect 91 data
```{r}
child2 <-read_dta(here::here("Data/zip_child_91/child291.dta")) %>% # note: here::here calls the here function
  rename_all(tolower) %>% 
  unite(basebrgy, basewman, sep = "_", col = "basebrgy_basewman")

hhold91 <-read_dta(here::here("Data/zip_household_91/hhold91.dta")) %>% # note: here::here calls the here function
  rename_all(tolower) %>% 
  unite(basebrgy, basewman, sep = "_", col = "basebrgy_basewman")


dim(child2)
dim(hhold91)

child2 %>%
  group_by(basebrgy_basewman) %>%
  summarize(n = n()) %>%
  filter(n > 1)
# Ok, 32 women with duplicates in this child2 file

hhold91 %>%
  group_by(basebrgy_basewman) %>%
  summarize(n = n()) %>%
  filter(n > 1)
# And 47 women with duplicates in the hhold91 file.
```
## Find the duplicates
```{r}
dups_child <-child2 %>%
  group_by(basebrgy_basewman) %>%
  summarize(n = n()) %>%
  filter(n > 1) %>% 
  pull(basebrgy_basewman)

dups_hhld91 <-hhold91 %>%
  group_by(basebrgy_basewman) %>%
  summarize(n = n()) %>%
  filter(n > 1) %>% 
  pull(basebrgy_basewman)

# Check Child2
child_foo <-child2 %>% 
  filter(basebrgy_basewman %in% c(dups_child)) %>% 
  arrange(basebrgy_basewman, stat1991) 

child_foo %>%
  nrow() 
# 68 rows

child_foo %>% 
  filter(stat1991 != 2 & 
           stat1991 != 3 &
           stat1991 != 4 &
           stat1991 > 8)
# 10 basebrgy_basewman/combinations where child not present. etc.


# Check hhold91
hhold_foo <-hhold91 %>% 
  filter(basebrgy_basewman %in% c(dups_hhld91)) %>% 
  arrange(basebrgy_basewman, stat1991) 

hhold_foo %>%
  nrow() 
# 94 rows!

hhold_foo %>% 
  filter(stat1991 != 2 & 
           stat1991 != 3 &
           stat1991 != 4 &
           stat1991 > 8)
# 14 basebrgy_basewman/combinations where child not present. etc.


# Summary: 
# There are many women with codes 10 (Other) or 11 (neither mother nor child present, but that retain values for heightndx etc. for the ICs. The goal will be to filter out those cases where missing values)

```
## Filter out the weird duplicates in 91
```{r}
child2 %>%
  select(basebrgy_basewman, weghtndx, hightndx) %>% 
  filter(!is.na(weghtndx) & !is.na(hightndx)) %>% 
  group_by(basebrgy_basewman) %>%
  summarize(n = n()) %>%
  filter(n > 1)  
# Great, this filters out all duplications for child2
 
```


```{r}
hhold91 %>% 
  select(basebrgy_basewman, mointr91, dyintrvw, yrintr91) %>% 
  unique()
# 2562 unique from a total of 2572 - 10 that are not unique

hhold91 %>% 
  select(basebrgy_basewman, mointr91, dyintrvw, yrintr91) %>% 
  filter(basebrgy_basewman %in% c(dups_hhld91)) %>% 
  unique()
# 94 rows, of which 84 are unique - 10 that are not unique

# Ok, sometimes the days are "slightly" off (interview over 2 dates, so maybe 5 days apart...). 5 days will not will not really affect growth

#  
hhold91_lag <-hhold91 %>% 
  filter(basebrgy_basewman %in% c(dups_hhld91)) %>% 
  select(basebrgy_basewman, mointr91, dyintrvw, yrintr91, stat1991) %>% 
  arrange(basebrgy_basewman, stat1991) %>% 
  mutate(interview_date91 = make_date(yrintr91+1900, mointr91, dyintrvw)) %>% 
  group_by(basebrgy_basewman) %>% 
  mutate(int_lag_time = interview_date91 - lead(interview_date91))

hhold91_lag

hhold91_lag %>% 
  ggplot(., aes(x = int_lag_time)) + 
  geom_histogram()
# Ok, so measurements all within 30 days. Most zero difference.
# Just use what's there.

hhold91 %>% 
  select(basebrgy_basewman, mointr91, dyintrvw, yrintr91) %>% 
  distinct(basebrgy_basewman, .keep_all = T) 
# This removes all rows that are not the same, using whichever day ends up being in there.

# 
```


```{r, cache = TRUE}
#subset child2 data

growth2 <-child2 %>%
  select(basebrgy_basewman, weghtndx, hightndx) %>% 
  filter(!is.na(weghtndx) & !is.na(hightndx)) 

#subset hh91 data

intw_date91 <- hhold91 %>% 
  select(basebrgy_basewman, mointr91, dyintrvw, yrintr91) %>% 
  distinct(basebrgy_basewman, .keep_all = T) 


growth91_data_nobday <- left_join(growth2, intw_date91, by = c("basebrgy_basewman"))

growth91_data_nobday

#join tables together to make growth91_data
intersect(names(growth91_data_nobday), names(birthdates_data))

growth91_data <- left_join(growth91_data_nobday, birthdates_data, by = c("basebrgy_basewman"))

growth91_data
#2,278 
```

```{r, cache=TRUE}
#make interview dates and find age at interview
growth91_data<- growth91_data %>% 
  mutate(intwdate91 = make_date( yrintr91+1900, mointr91, dyintrvw)) %>% 
  mutate(age91_days = as.numeric(intwdate91 - birthdate)) %>% 
  mutate(age91_years = as.numeric(intwdate91 - birthdate)/365.25) %>% 
  mutate(age_mo_91 = age91_years*12) %>% 
  filter(age91_days > 0) %>% 
  filter(weghtndx > 0) %>% 
  filter(hightndx > 0)

#calculate zscores for 91 data and rename hfaz/wfaz

growth91_data <- addWGSR(data = growth91_data, sex = "sexchild", firstPart= "weghtndx", secondPart = "age91_days", index = "wfa")

growth91_data <- addWGSR(data = growth91_data, sex = "sexchild", firstPart = "hightndx", secondPart = "age91_days", index = "hfa")

growth91_data <- growth91_data %>% 
  rename( wfaz_91 = wfaz, hfaz_91 = hfaz)


growth91_data
#  2,241 
```

```{r}
#model height and weight distributions
ggplot(growth91_data, aes(x= weghtndx))+
  geom_histogram(color = "white")+
  facet_wrap(~sexchild)

ggplot(growth91_data, aes(x=hightndx))+
  geom_histogram(color = "white")+
  facet_wrap(~sexchild)

summary_weight91 <- growth91_data %>%
  group_by(sexchild) %>% 
  drop_na() %>%
  summarize(mean_weight91 = mean(weghtndx),
            std_dev_weight91 = sd(weghtndx),
            med_weight91 = median(weghtndx),
            count = n(), .groups = "keep")

#height and weight summary stats
summary_height91 <- growth91_data %>%
  group_by(sexchild) %>% 
  drop_na() %>%
  summarize(mean_height91 = mean(hightndx),
            std_dev_height91 = sd(hightndx),
            med_height91 = median(hightndx),
            count = n(), .groups = "keep")

summary_weight91
summary_height91
```

#Load and inspect 2002 data

```{r}

anthdiet <-read_dta(here::here("Data/zip_child_2002/anthdiet.dta")) %>% # note: here::here calls the here function
  rename_all(tolower) %>% 
  unite(basebrgy, basewman, sep = "_", col = "basebrgy_basewman")

screen_data<-read_dta(here::here("Data/zip_child_2002/screen.dta")) %>% # note: here::here calls the here function
  rename_all(tolower) %>% 
  unite(basebrgy, basewman, sep = "_", col = "basebrgy_basewman")

#subset anthdiet
#calculate bmi
anthdiet <- anthdiet %>% 
  select(basebrgy_basewman, weight, height) %>% 
  filter(weight > 0) %>% 
  filter(height > 0) %>% 
  rename(weight_02 = weight, height_02 = height)

#subset screen_data
screen_data <- screen_data %>% 
  select(basebrgy_basewman, dayntrvw, yrntrvw, montrvw) %>% 
  mutate(intw_date02 = make_date(yrntrvw, montrvw, dayntrvw))
 
 
#make interview date and find age at interview
screen_data <- left_join(birthdates_data, screen_data, by = c("basebrgy_basewman")) %>% 
  mutate(age_days_02 = as.numeric(intw_date02 - birthdate)) %>% 
  mutate(age_years_02 = age_days_02/365.25) %>% 
  mutate(age_cutoff = if_else(age_years_02 > 19, 19, age_years_02)) %>% 
  mutate(age_cutoff_days = age_cutoff*365.25) %>% 
  filter(age_days_02 > 0)
  
  

growth02_data <- left_join(screen_data, anthdiet, by = c("basebrgy_basewman"))

growth02_data <- addWGSR(data = growth02_data, sex = "sexchild", firstPart= "height_02", secondPart = "age_cutoff_days", index = "hfa") %>% 
   rename(hfaz_02 = hfaz)


growth02_data

# We may need to check if we have any pregnant women in here. 
```


```{r, cache = TRUE}
#visualize hieght distribution
ggplot(growth02_data, aes(x=height_02))+
  geom_histogram(color = "white")+
  facet_wrap(~sexchild)

#visualize weight distribution 
ggplot(growth02_data, aes(x=weight_02))+
  geom_histogram(color = "white")+
  facet_wrap(~sexchild)

#summarize height 
summary_height_02 <- growth02_data %>%
  group_by(sexchild) %>% 
  drop_na() %>%
  summarize(mean_height02 = mean(height_02),
            std_dev_height02 = sd(height_02),
            med_height02 = median(height_02),
            max_height02 = max(height_02),
            min_height02 = min(height_02),
            count = n(), .groups = "keep")
summary_height_02

#summarize weight
summary_weight_02 <- growth02_data %>%
  group_by(sexchild) %>% 
  drop_na() %>%
  summarize(mean_weight02 = mean(weight_02),
            std_dev_height02 = sd(height_02),
            med_weight02 = median(weight_02),
            max_weight02 = max(weight_02),
            min_weight02 = min(weight_02),
            count = n(), .groups = "keep")

summary_weight_02
```

#2005 data
```{r, chache=TRUE}
#load anthdiet 05
anthdiet05 <-read_dta(here::here("Data/zip_child_2005/anthdiet.dta")) %>% # note: here::here calls the here function
  rename_all(tolower) %>% 
  unite(basebrgy, basewman, sep = "_", col = "basebrgy_basewman")

#subsetand  unite id variable
#calculate bmi
anthdiet05 <- anthdiet05 %>% 
  select(basebrgy_basewman, age, sex, weight, height) %>% 
  rename(weight_05 = weight, height_05 = height)
  
intersect(names(birthdates_data), names(anthdiet05))


growth05_data <- left_join(birthdates_data, anthdiet05, by = c("basebrgy_basewman")) %>% 
  mutate(height_m_05 = (height_05/100)) %>% 
  mutate( bmi_05 = (weight_05/(height_m_05^2))) %>% 
  filter(weight_05 > 0) %>% 
  filter(height_05 > 0)

growth05_data

#summarize height 
summary_height_05 <- growth05_data %>%
  group_by(sexchild) %>% 
  drop_na() %>%
  summarize(mean_height05 = mean(height_05),
            std_dev_height05 = sd(height_05),
            med_height05 = median(height_05),
            max_height05 = max(height_05),
            min_height05 = min(height_05),
            count = n(), .groups = "keep")
summary_height_05

#summarize weight
summary_weight_05 <- growth05_data %>%
  group_by(sexchild) %>% 
  drop_na() %>%
  summarize(mean_weight05 = mean(weight_05),
            std_dev_height05 = sd(height_05),
            med_weight05 = median(weight_05),
            max_weight05 = max(weight_05),
            min_weight05 = min(weight_05),
            count = n(), .groups = "keep")

summary_weight_05
 
#summarize bmi
summary_bmi_05 <- growth05_data %>%
  group_by(sexchild) %>% 
  drop_na() %>%
  summarize(mean_bmi = mean(bmi_05),
            std_dev_bmi = sd(bmi_05),
            med_bmi = median(bmi_05),
            max_bmi = max(bmi_05),
            min_bmi = min(bmi_05),
            count = n(), .groups = "keep")

summary_bmi_05


```



#zscore analysis

```{r, cache=TRUE }
#table of zscores :)


zscore_data <- left_join(growth83_86_data, growth91_data %>%  
                         select(-sexchild, -birthdate), by = c("basebrgy_basewman")) 
 


zscore_data_unfilt <- left_join(zscore_data, growth02_data %>% 
                         select(-sexchild, -birthdate), by = c("basebrgy_basewman")) 

zscore_data <- zscore_data_unfilt %>% 
  select(basebrgy_basewman, sexchild, age_days_birthweigh, age_days_infweigh, age91_days, hfaz_birth, hfaz_inf_12, hfaz_91, hfaz_02,  wfaz_birth, wfaz_inf_12, wfaz_91)
  

zscore_data


```

#Hfaz differences 
```{r, cache = TRUE}
#find the differences between hfaz

hfaz_diffs <- zscore_data %>% 
  select(basebrgy_basewman, sexchild, hfaz_birth, hfaz_inf_12, hfaz_91, hfaz_02) %>%
  mutate(hfa_diff_birth_inf12 = (hfaz_inf_12 - hfaz_birth)) %>% 
  mutate(hfa_diff_inf12_91 = (hfaz_91 - hfaz_inf_12)) %>% 
  mutate(hfa_diff_91_02 = (hfaz_02 - hfaz_91))

#visualize
hfaz_diffs
dim(hfaz_diffs)

```

#wfaz differences

```{r, cache=TRUE}

#make a table for birth and 2 yrs old data
#find the difference between these

wfaz_diffs <- zscore_data %>% 
  select(basebrgy_basewman, sexchild, wfaz_birth, wfaz_inf_12, wfaz_91) %>%
  mutate(wfa_diff_birth_inf12 = (wfaz_inf_12 - wfaz_birth)) %>% 
  mutate(wfa_diff_inf12_91 = (wfaz_91 - wfaz_inf_12))


#visualize
wfaz_diffs
dim(wfaz_diffs)

```

#Join all of the data needed into one table
```{r, cache =TRUE}
#join difference tables

zscore_diffs <- left_join(hfaz_diffs, wfaz_diffs %>% 
                            select(-sexchild), by = c("basebrgy_basewman"))
zscore_diffs
# Ok, we're introducing another 1000 almost here. This is a problem...
dim(hfaz_diffs)
dim(wfaz_diffs)
dim(zscore_diffs)
dim(zscore_diffs[duplicated(zscore_diffs$basebrgy_basewman),])[1]

length(unique(zscore_diffs$basebrgy_basewman)) == nrow(zscore_diffs)
zscore_diffs[duplicated(zscore_diffs$basebrgy_basewman),]


```

```{r}
#Figure out whats going on with repeating rows

#2 rows each-- look identical
hfaz_diffs %>% filter(basebrgy_basewman == "1_178")
wfaz_diffs %>% filter(basebrgy_basewman == "1_178")

#four rows
zscore_diffs %>% filter(basebrgy_basewman == "1_178")

mbirth2 %>% filter(basebrgy_basewman == "1_178")
mlong %>% filter(basebrgy_basewman == "1_178")
child2 %>% filter(basebrgy_basewman == "1_178")

#problem starts here-- same basebrgy_basewman with some different stuff 
#looking at stat1991 I think were dealing with a mother and her child
#What I'm wondering is if theres a mom and her kid for all the repeated rows, but only the kid has height/weight data, so when the files are merged identical weight and height is added to both rows
hhold91 %>% filter(basebrgy_basewman == "1_178")
anthdiet %>% filter(basebrgy_basewman == "1_178")
screen_data %>% filter(basebrgy_basewman == "1_178")
anthdiet05 %>% filter(basebrgy_basewman == "1_178")

```



```{r}
# join the growth datasets

growth_data1 <- left_join(growth83_86_data, growth91_data %>% 
                           select(-sexchild, -birthdate), by = c("basebrgy_basewman")) 

growth_data2 <- left_join(growth_data1, growth02_data %>% 
                           select( -sexchild, -birthdate), by = c("basebrgy_basewman"))
growth_data3 <- left_join(growth_data2, growth05_data %>% 
                           select(-sexchild, -birthdate), by = c("basebrgy_basewman"))
growth_data3

#join growth and difference datasets
growth_data_unfiltered <- left_join(growth_data3, zscore_diffs %>% 
                                      select(-sexchild, -wfaz_birth, -hfaz_birth, -hfaz_inf_12, -wfaz_inf_12, -wfaz_91, -hfaz_91, -hfaz_02), by = c("basebrgy_basewman")) %>% 
  separate(basebrgy_basewman, into = c("basebrgy", "basewman"), sep = "_")

growth_data_unfiltered

```

```{r}
#read in unc child ID data
unc_base_reprostat <-read_csv(here::here("Output/Data/CPR/unc_base_reprostat.csv"))
unc_base_reprostat

growth_data_unfiltered <- left_join(growth_data_unfiltered %>%
 as_character(basebrgy, basewman),
unc_base_reprostat %>%
 as_character(basebrgy, basewman),
by = c("basebrgy", "basewman"))

#organize variables into a better order
#rename variables so they're labeled with year

growth_data<- growth_data_unfiltered %>% 
   unite(basebrgy, basewman, sep = "_", col = "basebrgy_basewman") %>% 
  select(uncchdid, basebrgy_basewman, sexchild, sex, outcome, birthdate, intwdate, age_days_birthweigh, weightak_kg, heightcm, date_inf_meas, age_days_infweigh, hght_12, wght_12, intwdate91, age91_days, age_mo_91, age91_years, hightndx, weghtndx, intw_date02, age_days_02, age_years_02, age_cutoff, age_cutoff_days, height_02, weight_02, age, height_05, height_m_05, weight_05, bmi_05, hfaz_birth, hfaz_inf_12, hfaz_91, hfaz_02, hfa_diff_birth_inf12, hfa_diff_inf12_91, hfa_diff_91_02, wfaz_birth, wfaz_inf_12, wfaz_91, wfa_diff_birth_inf12, wfa_diff_inf12_91, reprostat, was_preg_no_na, trimester) %>% 
  rename(intwdate_birth = intwdate, weightak_birth_kg = weightak_kg, heightcm_birth = heightcm, weghtndx_91 = weghtndx, hightndx_91 = hightndx, age_cutoff_02 = age_cutoff, age_cutoff_02_days = age_cutoff_days, age_05 = age) 
  

growth_data

```


#read in epigenetic data
```{r}
clocks_data <- read_csv(here::here ("Data/Clocks/QC_Norm_LisaMcEwan_meth_DatMini3.output.csv"))

growth_clocks_data <- left_join(growth_data, clocks_data, by = c("uncchdid"))
growth_clocks_data

write.csv(growth_clocks_data,"growth_clocks_data.csv")

```
# modeling hfaz (no interactions)

## Birth to 2 years old
```{r, cache=TRUE}
# build regression models for birth hfaz
# minimal just clock data and z scores?
# CPR: No minimal models for now. Will run full models and those with interactions

# 12:56:33 From Calen Ryan (he/him/his) to Everyone:
# 	EEA ~ delta_growth + pregnancy_status + b_to_2
# 12:56:46 From Calen Ryan (he/him/his) to Everyone:
# 	EEA ~ delta_growth + pregnancy_status + b_to_2*delta_growth


grim_height_b_2_f<-lm(AgeAccelGrim ~ hfa_diff_birth_inf12 + 
                        was_preg_no_na, subset(growth_clocks_data, sex == "2"))

grim_height_b_2_m<-lm(AgeAccelGrim ~ hfa_diff_birth_inf12, subset(growth_clocks_data, sex == "1"))

pheno_height_b_2_f <-update(grim_height_b_2_f, AgeAccelPheno ~ .)

pheno_height_b_2_m <-update(grim_height_b_2_m, AgeAccelPheno ~ .-was_preg_no_na)

han_height_b_2_f <-update(grim_height_b_2_f, EEAA ~ .)


han_height_b_2_m <-update(grim_height_b_2_m, EEAA ~ . -was_preg_no_na)


horv_height_b_2_f <-update(grim_height_b_2_f, IEAA ~ .)


horv_height_b_2_m <-update(grim_height_b_2_m, IEAA ~ . -was_preg_no_na)

sjPlot::tab_model(grim_height_b_2_f, grim_height_b_2_m, 
                  pheno_height_b_2_f, pheno_height_b_2_m, 
                  han_height_b_2_f, han_height_b_2_m, 
                  horv_height_b_2_f, horv_height_b_2_m)


growth_clocks_data %>% 
  select(uncchdid, hfa_diff_birth_inf12, AgeAccelGrim, AgeAccelPheno, EEAA, IEAA) %>% 
  gather(key = clock_type, value = AgeAccel, -c(1,2)) %>% 
  na.omit() %>% 
  ggplot(., aes(x = hfa_diff_birth_inf12, y = AgeAccel, col = clock_type))+
  geom_point()+
  scale_color_brewer(type = "qual", palette = 6)+
  facet_wrap(~clock_type)+
  theme(legend.position = "none")


```

## 2 to 8 years old
```{r, cache=TRUE}
#hfaz 2years old model
grim_height_83_91_f <-lm(AgeAccelGrim ~ hfa_diff_inf12_91 + 
                        hfa_diff_birth_inf12 +
                        was_preg_no_na, subset(growth_clocks_data, sex == "2"))

grim_height_83_91_m<-lm(AgeAccelGrim ~ hfa_diff_inf12_91 + 
                        hfa_diff_birth_inf12, subset(growth_clocks_data, sex == "1"))

pheno_height_83_91_f <-update(grim_height_83_91_f, AgeAccelPheno ~ .)

pheno_height_83_91_m <-update(grim_height_83_91_m, AgeAccelPheno ~ .-was_preg_no_na)

han_height_83_91_f <-update(grim_height_83_91_f, EEAA ~ .)

han_height_83_91_m <-update(grim_height_83_91_m, EEAA ~ .-was_preg_no_na)

horv_height_83_91_f <-update(grim_height_83_91_f, IEAA ~ .)

horv_height_83_91_m <-update(grim_height_83_91_m, IEAA ~ .-was_preg_no_na)


sjPlot::tab_model(grim_height_83_91_f, grim_height_83_91_m, 
                  pheno_height_83_91_f, pheno_height_83_91_m, 
                  han_height_83_91_f, han_height_83_91_m, 
                  horv_height_83_91_f, horv_height_83_91_m)
```

## 8 to 19 years old
```{r, cache=TRUE}
#hfaz_91 minimal models

grim_height_91_02_f<-lm(AgeAccelGrim ~ hfa_diff_91_02 +
                     hfa_diff_birth_inf12 +
                     was_preg_no_na, subset(growth_clocks_data, sex == "2"))

grim_height_91_02_m<-lm(AgeAccelGrim ~ hfa_diff_91_02 +
                     hfa_diff_birth_inf12, subset(growth_clocks_data, sex == "1"))

pheno_height_91_02_f <-update(grim_height_91_02_f, AgeAccelPheno ~ .)

pheno_height_91_02_m <-update(grim_height_91_02_m, AgeAccelPheno ~ .-was_preg_no_na)

han_height_91_02_f <-update(grim_height_91_02_f, EEAA ~ .)

han_height_91_02_m <-update(grim_height_91_02_m, EEAA ~ .-was_preg_no_na)

horv_height_91_02_f <-update(grim_height_91_02_f, IEAA ~ .)

horv_height_91_02_m <-update(grim_height_91_02_m, IEAA ~ .-was_preg_no_na)


sjPlot::tab_model(grim_height_91_02_f, grim_height_91_02_m, 
                  pheno_height_91_02_f, pheno_height_91_02_m, 
                  han_height_91_02_f, han_height_91_02_m, 
                  horv_height_91_02_f, horv_height_91_02_m)
```


#modeling wfaz (no interactions)

## Birth to 2 years old
```{r, cache=TRUE}
#wfa birth minimal models
grim_weight_b_2_f<-lm(AgeAccelGrim ~ wfa_diff_birth_inf12 + was_preg_no_na, subset(growth_clocks_data, sex == "2")) 

grim_weight_b_2_m<-lm(AgeAccelGrim ~ wfa_diff_birth_inf12, subset(growth_clocks_data, sex == "1"))

pheno_weight_b_2_f <-update(grim_weight_b_2_f, AgeAccelPheno ~ .)

pheno_weight_b_2_m <-update(grim_weight_b_2_m, AgeAccelPheno ~ .)

han_weight_b_2_f <-update(grim_weight_b_2_f, EEAA ~ .)

han_weight_b_2_m <-update(grim_weight_b_2_m, EEAA ~ .)

horv_weight_b_2_f <-update(grim_weight_b_2_f, IEAA ~ .)

horv_weight_b_2_m <-update(grim_weight_b_2_m, IEAA ~ .)


sjPlot::tab_model(grim_weight_b_2_f, grim_weight_b_2_m, 
                  pheno_weight_b_2_f, pheno_weight_b_2_m, 
                  han_weight_b_2_f, han_weight_b_2_m, 
                  horv_weight_b_2_f, horv_weight_b_2_m)
```

## 2 to 8 years old
```{r, cache=TRUE}
#wfaz inf12 minimal models
grim_weight_83_91_f<-lm(AgeAccelGrim ~ wfa_diff_inf12_91 + 
                          wfa_diff_birth_inf12+
                          was_preg_no_na, subset(growth_clocks_data, sex == "2"))

grim_weight_83_91_m<-lm(AgeAccelGrim ~ wfa_diff_inf12_91+
                          wfa_diff_birth_inf12,
                          subset(growth_clocks_data, sex == "1"))
                        
pheno_weight_83_91_f <-update(grim_weight_83_91_f, AgeAccelPheno ~ .)

pheno_weight_83_91_m <-update(grim_weight_83_91_m, AgeAccelPheno ~ .)

han_weight_83_91_f <-update(grim_weight_83_91_f, EEAA ~ .)

han_weight_83_91_m <-update(grim_weight_83_91_m, EEAA ~ .)

horv_weight_83_91_f <-update(grim_weight_83_91_f, IEAA ~ .)

horv_weight_83_91_m <-update(grim_weight_83_91_m, IEAA ~ .)


sjPlot::tab_model(grim_weight_83_91_f, grim_weight_83_91_m, 
                  pheno_weight_83_91_f, pheno_weight_83_91_m, 
                  han_weight_83_91_f, han_weight_83_91_m, 
                  horv_weight_83_91_f, horv_weight_83_91_m)
```


# modeling hfaz (interactions)


## 2 to 8 years old
```{r, cache=TRUE}
#hfaz 2years old model
grim_height_83_91_intxn_f<-lm(AgeAccelGrim ~ hfa_diff_inf12_91 * 
                        hfa_diff_birth_inf12 +
                        was_preg_no_na, subset(growth_clocks_data, sex == "2"))

grim_height_83_91_intxn_m<-lm(AgeAccelGrim ~ hfa_diff_inf12_91 * 
                        hfa_diff_birth_inf12, subset(growth_clocks_data, sex == "1"))

pheno_height_83_91_intxn_f <-update(grim_height_83_91_intxn_f, AgeAccelPheno ~ .)

pheno_height_83_91_intxn_m <-update(grim_height_83_91_intxn_m, AgeAccelPheno ~ .-was_preg_no_na)

han_height_83_91_intxn_f <-update(grim_height_83_91_intxn_f, EEAA ~ .)

han_height_83_91_intxn_m <-update(grim_height_83_91_intxn_m, EEAA ~ .-was_preg_no_na)

horv_height_83_91_intxn_f <-update(grim_height_83_91_intxn_f, IEAA ~ .)

horv_height_83_91_intxn_m <-update(grim_height_83_91_intxn_m, IEAA ~ .-was_preg_no_na)


sjPlot::tab_model(grim_height_83_91_intxn_f, grim_height_83_91_intxn_m, 
                  pheno_height_83_91_intxn_f, pheno_height_83_91_intxn_m, 
                  han_height_83_91_intxn_f, han_height_83_91_intxn_m, 
                  horv_height_83_91_intxn_f, horv_height_83_91_intxn_m)
```

## 8 to 19 years old
```{r, cache=TRUE}
#hfaz_91 minimal models

grim_height_91_02_intxn_f<-lm(AgeAccelGrim ~ hfa_diff_91_02 *
                     hfa_diff_birth_inf12 +
                     was_preg_no_na, subset(growth_clocks_data, sex == "2"))

grim_height_91_02_intxn_m<-lm(AgeAccelGrim ~ hfa_diff_91_02 *
                     hfa_diff_birth_inf12, subset(growth_clocks_data, sex == "1"))

pheno_height_91_02_intxn_f <-update(grim_height_91_02_intxn_f, AgeAccelPheno ~ .)

pheno_height_91_02_intxn_m <-update(grim_height_91_02_intxn_m, AgeAccelPheno ~ .)

han_height_91_02_intxn_f <-update(grim_height_91_02_intxn_f, EEAA ~ .)

han_height_91_02_intxn_m <-update(grim_height_91_02_intxn_m, EEAA ~ .)

horv_height_91_02_intxn_f <-update(grim_height_91_02_intxn_f, IEAA ~ .)

horv_height_91_02_intxn_m <-update(grim_height_91_02_intxn_m, IEAA ~ .)

sjPlot::tab_model(grim_height_91_02_intxn_f, grim_height_91_02_intxn_m, 
                  pheno_height_91_02_intxn_f, pheno_height_91_02_intxn_m, 
                  han_height_91_02_intxn_f, han_height_91_02_intxn_m, 
                  horv_height_91_02_intxn_f, horv_height_91_02_intxn_m)

```


#modeling wfaz (interactions)


## 2 to 8 years old
```{r, cache=TRUE}
#wfaz inf12 minimal models
grim_weight_83_91_intxn_f<-lm(AgeAccelGrim ~ wfa_diff_inf12_91 * wfa_diff_birth_inf12 + was_preg_no_na, subset(growth_clocks_data, sex == "2"))

grim_weight_83_91_intxn_m<-lm(AgeAccelGrim ~ wfa_diff_inf12_91 * wfa_diff_birth_inf12, subset(growth_clocks_data, sex == "1"))

pheno_weight_83_91_intxn_f <-update(grim_weight_83_91_intxn_f, AgeAccelPheno ~ .)

pheno_weight_83_91_intxn_m <-update(grim_weight_83_91_intxn_m, AgeAccelPheno ~ .)

han_weight_83_91_intxn_f <-update(grim_weight_83_91_intxn_f, EEAA ~ .)

han_weight_83_91_intxn_m <-update(grim_weight_83_91_intxn_m, EEAA ~ .)

horv_weight_83_91_intxn_f <-update(grim_weight_83_91_intxn_f, IEAA ~ .)

horv_weight_83_91_intxn_m <-update(grim_weight_83_91_intxn_m, IEAA ~ .)


sjPlot::tab_model(grim_weight_83_91_intxn_f, grim_weight_83_91_intxn_m, 
                  pheno_weight_83_91_intxn_f, pheno_weight_83_91_intxn_m, 
                  han_weight_83_91_intxn_f, han_weight_83_91_intxn_m, 
                  horv_weight_83_91_intxn_f, horv_weight_83_91_intxn_m)

```

## Looked at another way (weight and height, females only, 83-91)
```{r}
sjPlot::tab_model(grim_weight_83_91_intxn_f, 
                  pheno_weight_83_91_intxn_f, 
                  han_weight_83_91_intxn_f,
                  horv_weight_83_91_intxn_f,
                  grim_height_83_91_intxn_f, 
                  pheno_height_83_91_intxn_f, 
                  han_height_83_91_intxn_f, 
                  horv_height_83_91_intxn_f)

```

## VIF checks
```{r}

vif(grim_height_83_91_f)
vif(grim_height_83_91_m)
vif(pheno_height_83_91_f)
vif(pheno_height_83_91_m)
vif(han_height_83_91_f)
vif(han_height_83_91_m)

vif(grim_height_91_02_f)
vif(grim_height_91_02_m)
vif(pheno_height_91_02_f)
vif(pheno_height_91_02_m)
vif(han_height_91_02_f)
vif(han_height_91_02_m)



```
```{r}
vif(grim_weight_83_91_f)
vif(grim_weight_83_91_m)
vif(pheno_weight_83_91_f)
vif(pheno_weight_83_91_m)
vif(han_weight_83_91_f)
vif(han_weight_83_91_m)
vif(horv_weight_83_91_f)
vif(horv_weight_83_91_m)
```
```{r}
vif(grim_height_83_91_intxn_f)
vif(grim_height_83_91_intxn_m)
vif(pheno_height_83_91_intxn_f)
vif(pheno_height_83_91_intxn_m)
vif(han_height_83_91_intxn_f)
vif(han_height_83_91_intxn_m)
vif(horv_height_83_91_intxn_f)
vif(horv_height_83_91_intxn_m)

```
```{r}
vif(grim_height_91_02_intxn_f)
vif(grim_height_91_02_intxn_m)
vif(pheno_height_91_02_intxn_f)
vif(pheno_height_91_02_intxn_m)
vif(han_height_91_02_intxn_f)
vif(han_height_91_02_intxn_m)
vif(horv_height_91_02_intxn_f)
vif(horv_height_91_02_intxn_m)
```
```{r}
vif(grim_weight_83_91_intxn_f)
vif(grim_weight_83_91_intxn_m)
vif(pheno_weight_83_91_intxn_f)
vif(pheno_weight_83_91_intxn_m)
vif(han_weight_83_91_intxn_f)
vif(han_weight_83_91_intxn_m)
vif(horv_weight_83_91_intxn_f)
vif(horv_weight_83_91_intxn_m)
```

# Plots: Catchup Growth

## hfaz and wfaz-score by sex
```{r}
z_checks <-growth_clocks_data %>% 
  select(uncchdid, sexchild, hfaz_birth:wfa_diff_inf12_91, was_preg_no_na, IEAA, EEAA, DNAmGrimAgeAdjAge, DNAmPhenoAgeAdjAge)

# Which is female...?
z_checks %>% 
  mutate(sexchild = as_factor(sexchild)) %>% 
  filter(!is.na(IEAA)) %>% 
  select(sexchild) %>% 
  summary()
# Ok, 2 is female

z_checks %>% 
  select(uncchdid, sexchild, contains("hfaz")) %>% 
  gather(key = measure, value = value, -c(1,2)) %>% 
  ggplot(., aes(x = measure,  y = value,  fill = as_factor(sexchild)))+
  geom_boxplot()+
  scale_fill_brewer(palette = "Set1")+
  theme_bw()
# Note, 2 is female
# 
# 
z_checks %>% 
  select(uncchdid, sexchild, contains("wfaz")) %>% 
  gather(key = measure, value = value, -c(1,2)) %>% 
  ggplot(., aes(x = measure,  y = value,  fill = as_factor(sexchild)))+
  geom_boxplot()+
  scale_fill_brewer(palette = "Set1")+
  theme_bw()
# Note, 2 is female
```
## Changes in hfaz and wfaz-score by sex
```{r}
z_checks %>% 
  select(uncchdid, sexchild, contains("hfa_diff")) %>% 
  gather(key = measure, value = value, -c(1,2)) %>% 
  ggplot(., aes(x = measure,  y = value,  fill = as_factor(sexchild)))+
  geom_boxplot()+
  scale_fill_brewer(palette = "Set1")+
  theme_bw()
# Note, 2 is female

z_checks %>% 
  select(uncchdid, sexchild, contains("wfa_diff")) %>% 
  gather(key = measure, value = value, -c(1,2)) %>% 
  ggplot(., aes(x = measure,  y = value,  fill = as_factor(sexchild)))+
  geom_boxplot()+
  scale_fill_brewer(palette = "Set1")+
  theme_bw()

# Note, 2 is female
```
## Growth curves with mean
```{r}




```

```{r, eval = FALSE}
z_checks %>% 
  group_by(sexchild) %>%
  select(contains("hfa"), contains("wfa")) %>% 
  summarize_all(list(mean = mean, sd = sd), na.rm = TRUE)


stargazer::stargazer(as.data.frame(z_checks))
                     
                     
stargazer::stargazer(as.data.frame(z_checks %>% filter(sexchild == 1)), type = "html", 
                     summary = TRUE, 
                     out = here::here("Output/Figures/z_checks_boys.html"))

stargazer::stargazer(as.data.frame(z_checks %>% filter(sexchild == 2)), type = "html", 
                     summary = TRUE, 
                     out = here::here("Output/Figures/z_checks_girls.html"))
```

```{r}
t.test(z_checks$hfaz_birth, z_checks$sexchild)



sapply(z_checks[,-c(1:2, 15:19)], function(i) t.test(i ~ z_checks$sexchild))

```

